---
title: "arimatrainPol"
output: html_document
---

Cargamos la función de evaluación.
```{r}
getPred_ts<- function(Xtrain, Xtest, getPredFunc, models){
  
  H <- nrow(Xtest)
  mu_hat <- matrix(NA, H, 5)
  se_hat <- matrix(NA, H, 5)
  

  X_test_past <- Xtest[0,]
  for (h in seq_len(H)) {
    for (i in 1:5){
      # update model state with data up to t-1 (parameters fixed)
      pred <- do.call(getPredFunc, list(Xtrain[,i], X_test_past[,i], models[[i]]))
      mu_hat[h,i] <- pred$mu_hat
      se_hat[h,i] <- pred$se_hat
    }
    X_test_past <- Xtest[1:h,,drop=FALSE]
  }
  return(list(mu_hat=mu_hat, se_hat=se_hat))
}

getPred <- function(x_train, x_test_past, mod){
  x_past <- c(x_train, x_test_past)
  fit_upd <- Arima(x_past, model = mod)
  fc <- forecast::forecast(fit_upd, h = 1)
  mu_hat  <- as.numeric(fc$mean[1])
  z80 <- qnorm(0.8)
  se_from_up <- (fc$upper[,"80%"][1] - fc$mean[1]) / z80
  se_from_lo <- (fc$mean[1]  - fc$lower[,"80%"][1]) / z80
  se_hat_aux <- pmax(se_from_up, se_from_lo) 
  se_hat  <- as.numeric(se_hat_aux)
  return(list(mu_hat=mu_hat, se_hat=se_hat))
}
```



Importamos el dataframe.
```{r}
library(readr)
library(forecast)

df_train <- read_csv("./data/stock_returns_train.csv")
```
Pasamos a formato serie temporal.
```{r}
df_ts <- ts(df_train, frequency=12)

df_train <- ts(df_ts[1:(7*12),], frequency=12)
df_test <- ts(df_ts[(7*12+1):length(df_ts[,1]),], frequency=12)
```

Ploteamos los resultados.
```{r}
plot(df_train)
```

Entrenar modelos finales y guardarlos

```{r}
# Entrenar modelos ARIMA con TODOS los datos de entrenamiento (7 años)
models <- list()

for (serie in 1:5) {
  # Usar auto.arima para selección automática
  model <- auto.arima(df_train[, serie])
  models[[serie]] <- model
  
  # Opcional: guardar también el orden (p,d,q) para referencia
  cat(sprintf("Serie %d: ARIMA(%d,%d,%d)\n", 
              serie, 
              model$arma[1],  # p
              model$arma[6],  # d  
              model$arma[2])) # q
}
```

Simular periodo test con oneStepAhead

```{r}
df <- data.frame(getPred_ts(df_train,df_test,getPred,models))
```



